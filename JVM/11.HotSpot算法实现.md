---
title: 11.HotSpot算法实现
tags: []
---

##### 枚举根节点

&#8195;&#8195;可达性分析对执行时间的敏感体现在GC停顿上，因为这项分析工作必须在一个能确保一致性的快照中进行，**“一致性”的意思是指在整个分析期间整个执行系统看起来就像被冻结在某个时间点上，不可以出现分析过程中对象引用关系还在不断变化，如果不能保证一致性那么分析结果准确性也就无法保证**。这点是导致GC进行时必须停顿所有Java执行线程（Sun将这件事情称为“Stop The World”）的其中一个重要原因，即使是在号称（几乎）不会发生停顿的CMS收集器中，枚举根节点时也是必须要停顿的。

&#8195;&#8195;目前主流Java虚拟机使用的都是准确式GC，当系统停下来后，并不需要一个不漏地检查完所有执行上下文和全局的引用位置，虚拟机应当是有办法直接得知哪些地方存放着对象引用。在HotSpot的实现中，是使用一组称为OopMap的数据结构来达到这个目的的，**在类加载完成的时候，HotSpot就把对象内 什么偏移量上是什么类型的数据计算出来，在JIT编译过程中，也会在特定的位置记录下栈和寄存器中哪些位置是引用。**

##### 安全点

&#8195;&#8195;**HotSpot没有为每条指令都生成OopMap，只是在“特定的位置”记录了这些信息，这些位置称为安全点（Safepoint），即程序执行时并非在所有地方都能停顿下来开始GC，只有在到达安全点时才能暂停**。`Safepoint`的选定既不能太少以致于让GC等待时间太长，也不能太过频繁以致于增大运行时的负荷。

&#8195;&#8195;对于Safepoint，需要考虑的问题是如何在GC发生时让所有线程（不包括执行JNI调用的线程）都跑到最近的安全点再停顿下来。
- 抢断式中断（Preemptive Suspension）不需要线程的执行代码主动去配合，在GC发生时，首先先把所有线程全部中断，如果发现所有线程中断的地方不在安全点上，就恢复线程，让它“跑”到安全点上。现在很少是采用这种方式来相应GC事件。
- 主动式中断（Voluntary Suspension）当GC需要中断线程的时候，直接对线程操作，仅仅简单设置一个标志，各个线程执行时主动去轮询这个标志
，发现中断标志为真时就自己中断挂起。轮询标志的地方和安全点是重合的，另外再加上创建对象需要分配内存的地方。

##### 安全区域

&#8195;&#8195;安全区域（Safe Region）是指在一段代码之中，引用关系不会发生变化。在这个区域中的任何地方开始GC都是安全的。我们也可以把Safe Region看作是被拓展的SafePoint。

&#8195;&#8195;在线程执行到Safe Region中的代码时，首先标识自己已经进入Safe Region，当这段时间JVM要发起GC时，就不用管标识自己为Safe Region状态的线程了。在线程要离开Safe Region时，它要检查系统是否已经完成了根节点枚举，若完成线程继续执行下去，否则必须等待收到可以安全离开Safe Region的信号为止。
